{% extends "base.html" %}

{% block content %}
  <div class="form-container">
    <h2 style="text-align:center;">üìä –ì—Ä–∞—Ñ—ñ–∫ –∫—É—Ä—Å—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∏</h2>
    <form method="post">
      {% csrf_token %}
      <label>–û–±–µ—Ä—ñ—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É:</label>
      <select name="currency" class="form-control">
        {% for currency in currencies %}
          <option value="{{ currency.id }}" {% if selected_currency and currency.id == selected_currency.id %}selected{% endif %}>
            {{ currency.name }}
          </option>
        {% endfor %}
      </select>

      <label>–§—ñ–∞—Ç–Ω–∞ –≤–∞–ª—é—Ç–∞:</label>
      <select name="fiat" class="form-control">
        {% for f in fiat_currencies %}
          <option value="{{ f }}" {% if f == selected_fiat %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
      </select>

      <label>–ü–µ—Ä—ñ–æ–¥ (—É –¥–Ω—è—Ö):</label>
      <select name="days" class="form-control">
        {% for d in periods %}
          <option value="{{ d }}" {% if selected_days == d|stringformat:"s" %}selected{% endif %}>{{ d }} –¥–Ω—ñ–≤</option>
        {% endfor %}
      </select>

      <button type="submit">–ü–æ–∫–∞–∑–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
    </form>

    {% if chart_data %}
      <canvas id="priceChart" width="400" height="200"></canvas>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        const ctx = document.getElementById('priceChart').getContext('2d');
        const chartData = {{ chart_data|safe }};

        const labels = chartData.map(item => {
          const date = new Date(Number(item[0]));
          return date.toLocaleDateString("uk-UA");
        });

        const prices = chartData.map(item => item[1]);

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: `–¶—ñ–Ω–∞ –∑–∞ {{ selected_days }} –¥–Ω—ñ–≤ (USD)`,
              data: prices,
              borderWidth: 2,
              borderColor: 'rgba(255,99,132,1)',
              fill: false,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: false
              }
            }
          }
        });
      </script>
    {% endif %}
  </div>
{% endblock %}