{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow-lg">
    <div class="card-header bg-danger text-white">
      <h4 class="mb-0">üîî –í–∞—à—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h4>
      <form method="post" action="{% url 'create_price_watch' %}" class="mt-3">
        {% csrf_token %}
        <div class="form-row align-items-end">
          <div class="col-md-4">
            <label for="currencySelect">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</label>
            <select id="currencySelect" name="currency" class="form-control" required>
              <option value="" disabled selected>-- –û–±–µ—Ä—ñ—Ç—å –≤–∞–ª—é—Ç—É --</option>
              {% for currency in currencies %}
                <option value="{{ currency.id }}">{{ currency.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label for="fiatCurrency">–§—ñ–∞—Ç</label>
            <select id="fiatCurrency" name="fiat_currency" class="form-control">
              <option value="USD">USD</option>
              <option value="UAH">UAH</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="period">–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å (—Ö–≤)</label>
            <input type="number" id="period" name="period_minutes" class="form-control" min="1" value="10">
          </div>
          <div class="col-md-1">
            <button type="submit" class="btn btn-danger">‚ûï</button>
          </div>
        </div>
      </form>
    </div>
    <div class="card-body bg-dark text-white">
      <ul class="list-group list-group-flush" id="notificationList">
        {% for n in notifications %}
          <li class="list-group-item bg-dark text-white border-secondary">
            <strong>{{ n.created_at|date:"d.m.Y H:i" }}</strong> ‚Äì {{ n.message }}
          </li>
        {% empty %}
          <div class="alert alert-secondary text-center" role="alert">
            –°–ø–æ–≤—ñ—â–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î.
          </div>
        {% endfor %}
      </ul>
    </div>
  </div>
  <hr class="bg-light my-4">
  <h5 class="text-white">üìã –ê–∫—Ç–∏–≤–Ω—ñ –ø—ñ–¥–ø–∏—Å–∫–∏</h5>
  <table class="table table-dark table-striped table-bordered">
    <thead>
      <tr>
        <th>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</th>
        <th>–§—ñ–∞—Ç</th>
        <th>–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å</th>
        <th>–û—Å—Ç–∞–Ω–Ω—è —Ü—ñ–Ω–∞</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for watch in price_watches %}
        <tr>
          <td>{{ watch.currency.symbol }}</td>
          <td>{{ watch.fiat_currency }}</td>
          <td>{{ watch.period_minutes }} —Ö–≤</td>
          <td>{% if watch.last_price %}{{ watch.last_price|floatformat:2 }}{% else %}‚Äì{% endif %}</td>
          <td>
            <form method="post" action="{% url 'delete_price_watch' watch.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5" class="text-center text-secondary">–ü—ñ–¥–ø–∏—Å–æ–∫ —â–µ –Ω–µ–º–∞—î.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  async function fetchNotifications() {
    try {
      const res = await fetch("{% url 'api_notifications' %}");
      if (!res.ok) return;
      const data = await res.json();
      const list = document.getElementById("notificationList");
      list.innerHTML = "";

      if (data.notifications.length === 0) {
        list.innerHTML = '<div class="alert alert-secondary text-center">–°–ø–æ–≤—ñ—â–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î.</div>';
        return;
      }

      for (const n of data.notifications) {
        const li = document.createElement("li");
        li.className = "list-group-item bg-dark text-white border-secondary";
        li.innerHTML = `<strong>${n.created_at}</strong> ‚Äì ${n.message}`;
        list.appendChild(li);
      }
    } catch (e) {
      console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è", e);
    }
  }

  fetchNotifications();
  setInterval(fetchNotifications, 10000); // –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
</script>
{% endblock %}